<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.spark.chat.repository.ChatMapper">

    <resultMap id="chatResultMap" type="com.spark.chat.model.Chat">
        <result column="cl_no" property="clNo"/>
        <result column="cl_newmsg" property="clNewMsg"/>
        <result column="cl_lastmsgtime" property="lastMsgTime"/>
        <result column="mem_nickname" property="nickName"/>
        <result column="mem_profile" property="proFile"/>
        <result column="mem_id" property="memId"/>
        <result column="chat_title" property="chatTitle"/>
        <association property="message" javaType="com.spark.chat.model.Message">
            <result column="msg_no" property="msgNo"/>
            <result column="msg_content" property="messageContent"/>
            <result column="msg_regist_date" property="messageRegistDate"/>
            <result column="msg_id" property="msgId"/>
        </association>

    </resultMap>


    <resultMap id="chatMessageResultMap" type="com.spark.chat.model.Chat">
        <id column="msg_no" property="rowNo"/>
        <result column="cl_no" property="clNo"/>
        <result column="cl_newmsg" property="clNewMsg"/>
        <result column="cl_lastmsgtime" property="lastMsgTime"/>
        <result column="mem_nickname" property="nickName"/>
        <result column="mem_profile" property="proFile"/>
        <result column="mem_id" property="memId"/>
        <result column="chat_title" property="chatTitle"/>


        <association property="message" javaType="com.spark.chat.model.Message">
            <id column="msg_no" property="msgNo"/>
            <result column="msg_content" property="messageContent"/>
            <result column="msg_regist_date" property="messageRegistDate"/>
            <result column="msg_id" property="msgId"/>
        </association>

    </resultMap>


    <!-- 채팅 목록 조회 -->
    <select id="chatList" resultMap="chatResultMap">
        select cm.cl_No
             , cm_Id as mem_id
             , mem_nickname
             , mem_profile
             , cl.cl_newmsg
             , cl_lastmsgtime
        from chat_member cm
                 join MEMBER m on cm.cm_ID = m.mem_id
                 join chat_list cl on cl.cl_no = cm.cl_no
        where cm.cl_no in (SELECT cm.CL_NO
                           FROM CHAT_MEMBER cm
                           WHERE cm.CM_ID = #{memId})
          AND cm.CM_ID != #{memId}


    </select>

    <!-- 채팅방 메시지 불러오기 -->
    <select id="message" resultMap="chatMessageResultMap">
        select msg_no
             , msg_content
             , msg_regist_date
             , msg_id
             , cl_no
             , (select DISTINCT mem_nickname
                from MEMBER m
                         join chat_member cm on m.mem_id = cm.cm_id
                where mem_id != #{memId}
                  and cl_no = #{clNo}) as chat_title
             , mem_nickname
             , mem_profile
        from message msg
                 join MEMBER m on m.mem_id = msg.msg_id
        where cl_no = #{clNo}
        order by msg_no

    </select>


    <!-- 채팅방 메시지 등록 -->
    <insert id="sendMessage">
        insert
        into message
            (msg_content, msg_id, cl_no)
        values ( #{message.messageContent}
               , #{message.messageId}
               , #{clNo})

    </insert>

    <!-- 채팅방 생성 -->
    <insert id="createChatRoom" useGeneratedKeys="true" keyProperty="clNo" keyColumn="cl_no" parameterType="com.spark.chat.model.Chat">
        insert
        into chat_list
            (CL_LASTMSGTIME)
        values (now())
    </insert>

    <!-- 채팅방 멤버 등록 -->
    <insert id="insertChatMember">
        insert
        into chat_member
            (cl_no, cm_id)
        values (#{clNo}, #{memId})
    </insert>

    <!-- 채팅방 최신 메시지 업데이트 -->
    <update id="newMsgUpdate">
        update chat_list
        set cl_newMsg      = #{message.messageContent}
          , cl_lastMsgTime = now()
        where cl_no = #{clNo}
    </update>

</mapper>
